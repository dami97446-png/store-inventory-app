import React, { useState, useEffect, useMemo, useCallback, createContext, useContext } from 'react';
import { 
  Box, Plus, Search, Archive, AlertTriangle, Database, 
  CircleDollarSign, ShoppingCart, Edit, Trash2, X, Loader2, 
  Sparkles, Settings, Download, Upload, Moon, Sun, Minus
} from 'lucide-react';

// --- 0. POLYFILL: UUID SUPPORT ---
// Fixes "crypto.randomUUID is not a function" errors in some browser/preview environments
if (typeof crypto !== 'undefined' && !crypto.randomUUID) {
  crypto.randomUUID = () => {
    return '10000000-1000-4000-8000-100000000000'.replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  };
}

// --- 1. ARCHITECTURE: THE DATA LAYER (Custom Hooks) ---
// This replaces Firebase. We use LocalStorage now, but this structure
// makes it easy to swap for Supabase or SQL later without breaking the UI.

const usePersistentStore = (key, initialValue) => {
  const [data, setData] = useState(() => {
    try {
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : initialValue;
    } catch (error) {
      console.error(`Error reading ${key}:`, error);
      return initialValue;
    }
  });

  useEffect(() => {
    try {
      window.localStorage.setItem(key, JSON.stringify(data));
    } catch (error) {
      console.error(`Error saving ${key}:`, error);
    }
  }, [key, data]);

  return [data, setData];
};

// --- 2. GEMINI API INTEGRATION ---
// Now accepts a dynamic API Key from settings

const callGeminiAPI = async (userQuery, systemPrompt, apiKey) => {
  if (!apiKey) return "Error: No API Key configured in Settings.";
  
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
  
  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] }
      })
    });

    if (!response.ok) throw new Error(`API Error: ${response.status}`);
    const result = await response.json();
    return result.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
  } catch (error) {
    console.error("Gemini Error:", error);
    return "Error connecting to AI service.";
  }
};

// --- 3. APP CONTEXT & STATE ---

const AppContext = createContext();

export default function App() {
  // --- State Management ---
  const [inventory, setInventory] = usePersistentStore('inventory_v1', []);
  const [sales, setSales] = usePersistentStore('sales_v1', []);
  const [history, setHistory] = usePersistentStore('history_v1', []);
  const [settings, setSettings] = usePersistentStore('settings_v1', { 
    apiKey: '', 
    storeName: 'My Store', 
    currency: 'PHP',
    darkMode: false 
  });

  const [view, setView] = useState('dashboard');
  const [modalState, setModalState] = useState({ type: null, data: null }); // 'add', 'edit', 'sell', 'insights', 'settings'
  const [message, setMessage] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);

  // --- Actions (Business Logic) ---
  
  const logAction = (action, details) => {
    const newEntry = {
      id: crypto.randomUUID(),
      action,
      details,
      timestamp: new Date().toISOString()
    };
    setHistory(prev => [newEntry, ...prev]);
  };

  const addItem = (itemData) => {
    const newItem = { 
      id: crypto.randomUUID(), 
      ...itemData, 
      lastRestocked: new Date().toISOString(),
      createdAt: new Date().toISOString() 
    };
    setInventory(prev => [...prev, newItem]);
    logAction('Item Added', `Added ${itemData.name}`);
    showMessage('success', 'Item added successfully');
    setModalState({ type: null });
  };

  const updateItem = (id, updates) => {
    setInventory(prev => prev.map(item => {
      if (item.id !== id) return item;
      const updated = { ...item, ...updates, updatedAt: new Date().toISOString() };
      // If quantity increased, update restock date
      if (updates.quantity > item.quantity) updated.lastRestocked = new Date().toISOString();
      return updated;
    }));
    logAction('Item Updated', `Updated item ID: ${id}`);
    showMessage('success', 'Item updated');
    setModalState({ type: null });
  };

  const deleteItem = (id, name) => {
    setInventory(prev => prev.filter(item => item.id !== id));
    logAction('Item Deleted', `Deleted ${name}`);
    showMessage('success', 'Item deleted');
    setModalState({ type: null });
  };

  const sellItem = (item, quantitySold) => {
    const total = quantitySold * item.price;
    
    // 1. Reduce Inventory
    updateItem(item.id, { quantity: item.quantity - quantitySold });
    
    // 2. Record Sale
    const newSale = {
      id: crypto.randomUUID(),
      itemId: item.id,
      itemName: item.name,
      quantity: quantitySold,
      total,
      date: new Date().toISOString()
    };
    setSales(prev => [newSale, ...prev]);
    
    logAction('Sale', `Sold ${quantitySold} x ${item.name}`);
    showMessage('success', 'Sale recorded!');
    setModalState({ type: null });
  };

  // --- Data Export/Import ---
  const exportData = () => {
    const dataStr = JSON.stringify({ inventory, sales, history, settings }, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `inventory_backup_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    showMessage('success', 'Data exported successfully');
  };

  const importData = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        if (data.inventory) setInventory(data.inventory);
        if (data.sales) setSales(data.sales);
        if (data.history) setHistory(data.history);
        if (data.settings) setSettings(data.settings);
        showMessage('success', 'Data imported successfully');
      } catch (err) {
        showMessage('error', 'Invalid backup file');
      }
    };
    reader.readAsText(file);
  };

  const showMessage = (type, content) => {
    setMessage({ type, content });
    setTimeout(() => setMessage(null), 3000);
  };

  // --- Computed Metrics ---
  const metrics = useMemo(() => {
    return {
      totalItems: inventory.reduce((sum, i) => sum + (parseInt(i.quantity) || 0), 0),
      lowStock: inventory.filter(i => i.quantity < 10).length,
      value: inventory.reduce((sum, i) => sum + (i.quantity * i.price), 0),
      salesTotal: sales.reduce((sum, s) => sum + s.total, 0)
    };
  }, [inventory, sales]);

  const filteredInventory = useMemo(() => {
    if (!searchQuery) return inventory;
    const q = searchQuery.toLowerCase();
    return inventory.filter(i => 
      i.name.toLowerCase().includes(q) || 
      i.sku?.toLowerCase().includes(q) || 
      i.category?.toLowerCase().includes(q)
    );
  }, [inventory, searchQuery]);

  // --- Render Helpers ---
  const currencyFormatter = new Intl.NumberFormat('en-US', { 
    style: 'currency', 
    currency: settings.currency 
  });

  // --- Theme Class ---
  const themeClass = settings.darkMode ? 'bg-gray-900 text-gray-100' : 'bg-gray-100 text-gray-800';
  const cardClass = settings.darkMode ? 'bg-gray-800 border-gray-700 text-white' : 'bg-white border-gray-200 text-gray-900';

  return (
    <AppContext.Provider value={{ settings, setSettings, isGenerating, setIsGenerating, callGeminiAPI, showMessage }}>
      <div className={`min-h-screen font-sans transition-colors duration-200 ${themeClass}`}>
        <div className="container mx-auto p-4 max-w-6xl">
          
          <Header 
            onOpenModal={setModalState} 
            setView={setView} 
            view={view}
            exportData={exportData}
            importData={importData}
            darkMode={settings.darkMode}
          />

          {message && (
            <div className={`fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 animate-fade-in ${
              message.type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
            }`}>
              {message.content}
            </div>
          )}

          {view === 'dashboard' && (
            <main className="space-y-6">
              <MetricsGrid metrics={metrics} formatter={currencyFormatter} cardClass={cardClass} />
              
              <div className="flex flex-col md:flex-row gap-4">
                <div className="relative flex-grow">
                  <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                  <input 
                    type="text" 
                    placeholder="Search inventory..." 
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className={`w-full pl-10 pr-4 py-3 rounded-xl border focus:ring-2 focus:ring-blue-500 outline-none transition-all ${
                      settings.darkMode ? 'bg-gray-800 border-gray-700 text-white placeholder-gray-500' : 'bg-white border-gray-300'
                    }`}
                  />
                </div>
              </div>

              <InventoryTable 
                items={filteredInventory} 
                formatter={currencyFormatter} 
                onAction={(type, item) => setModalState({ type, data: item })}
                cardClass={cardClass}
                darkMode={settings.darkMode}
              />
            </main>
          )}

          {view === 'history' && <HistoryList history={history} cardClass={cardClass} />}

          {/* --- MODALS --- */}
          {modalState.type === 'add' && (
            <ItemModal 
              title="Add New Item"
              onClose={() => setModalState({ type: null })}
              onSubmit={addItem}
              cardClass={cardClass}
            />
          )}

          {modalState.type === 'edit' && (
            <ItemModal 
              title="Edit Item"
              initialData={modalState.data}
              onClose={() => setModalState({ type: null })}
              onSubmit={(data) => updateItem(modalState.data.id, data)}
              cardClass={cardClass}
            />
          )}

          {modalState.type === 'sell' && (
            <SellModal 
              item={modalState.data}
              onClose={() => setModalState({ type: null })}
              onConfirm={sellItem}
              cardClass={cardClass}
              formatter={currencyFormatter}
            />
          )}

          {modalState.type === 'delete' && (
            <DeleteConfirm 
              item={modalState.data}
              onClose={() => setModalState({ type: null })}
              onConfirm={() => deleteItem(modalState.data.id, modalState.data.name)}
              cardClass={cardClass}
            />
          )}

          {modalState.type === 'insights' && (
            <InsightsModal 
              data={{ inventory, sales, metrics }}
              onClose={() => setModalState({ type: null })}
              cardClass={cardClass}
            />
          )}

          {modalState.type === 'settings' && (
            <SettingsModal 
              onClose={() => setModalState({ type: null })}
              cardClass={cardClass}
            />
          )}

        </div>
      </div>
    </AppContext.Provider>
  );
}

// --- SUB-COMPONENTS ---

const Header = ({ onOpenModal, setView, view, exportData, importData, darkMode }) => {
  const { setSettings } = useContext(AppContext);
  
  return (
    <header className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
      <div className="flex items-center gap-3">
        <div className="bg-blue-600 p-2.5 rounded-xl shadow-lg shadow-blue-600/20">
          <Box className="text-white" size={28} />
        </div>
        <div>
          <h1 className={`text-2xl font-bold tracking-tight ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            Store Inventory
          </h1>
          <p className={`text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
            Local Edition
          </p>
        </div>
      </div>

      <div className="flex flex-wrap items-center gap-2">
        <button 
          onClick={() => setView('dashboard')} 
          className={`px-4 py-2 rounded-lg font-medium transition-colors ${view === 'dashboard' ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-200 text-gray-600'}`}
        >
          Dashboard
        </button>
        <button 
          onClick={() => setView('history')} 
          className={`px-4 py-2 rounded-lg font-medium transition-colors ${view === 'history' ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-200 text-gray-600'}`}
        >
          History
        </button>
        
        <div className="w-px h-6 bg-gray-300 mx-2 hidden md:block"></div>

        <button onClick={() => onOpenModal({ type: 'insights' })} className="p-2 text-purple-600 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors" title="AI Insights">
          <Sparkles size={20} />
        </button>

        <button onClick={() => onOpenModal({ type: 'settings' })} className="p-2 text-gray-600 hover:bg-gray-200 rounded-lg transition-colors" title="Settings">
          <Settings size={20} />
        </button>

        <div className="relative group">
          <button className="p-2 text-gray-600 hover:bg-gray-200 rounded-lg transition-colors">
            <Download size={20} />
          </button>
          <div className="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-gray-100 p-2 hidden group-hover:block z-10">
            <button onClick={exportData} className="flex items-center w-full p-2 hover:bg-gray-50 rounded-lg text-sm text-gray-700 text-left">
              <Download size={14} className="mr-2" /> Export Backup
            </button>
            <label className="flex items-center w-full p-2 hover:bg-gray-50 rounded-lg text-sm text-gray-700 cursor-pointer">
              <Upload size={14} className="mr-2" /> Import Backup
              <input type="file" className="hidden" accept=".json" onChange={importData} />
            </label>
          </div>
        </div>

        <button 
          onClick={() => setSettings(s => ({ ...s, darkMode: !s.darkMode }))}
          className="p-2 text-gray-600 hover:bg-gray-200 rounded-lg transition-colors"
        >
          {darkMode ? <Sun size={20} /> : <Moon size={20} />}
        </button>
        
        <button 
          onClick={() => onOpenModal({ type: 'add' })}
          className="flex items-center gap-2 bg-blue-600 text-white px-5 py-2 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-600/20 transition-all transform active:scale-95 font-medium ml-2"
        >
          <Plus size={18} /> Add Item
        </button>
      </div>
    </header>
  );
};

const MetricsGrid = ({ metrics, formatter, cardClass }) => (
  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
    <MetricCard 
      title="Total Items" 
      value={metrics.totalItems} 
      icon={<Archive className="text-blue-500" />} 
      cardClass={cardClass} 
    />
    <MetricCard 
      title="Low Stock" 
      value={metrics.lowStock} 
      icon={<AlertTriangle className={metrics.lowStock > 0 ? "text-amber-500" : "text-gray-400"} />} 
      warning={metrics.lowStock > 0}
      cardClass={cardClass} 
    />
    <MetricCard 
      title="Inv. Value" 
      value={formatter.format(metrics.value)} 
      icon={<Database className="text-emerald-500" />} 
      cardClass={cardClass} 
    />
    <MetricCard 
      title="Total Sales" 
      value={formatter.format(metrics.salesTotal)} 
      icon={<CircleDollarSign className="text-violet-500" />} 
      cardClass={cardClass} 
    />
  </div>
);

const MetricCard = ({ title, value, icon, warning, cardClass }) => (
  <div className={`p-5 rounded-2xl border transition-all ${cardClass} ${warning ? 'ring-2 ring-amber-100' : ''}`}>
    <div className="flex justify-between items-start mb-2">
      <span className="text-sm font-medium opacity-70">{title}</span>
      <div className="p-2 bg-gray-50/50 rounded-lg">{icon}</div>
    </div>
    <div className={`text-2xl font-bold ${warning ? 'text-amber-600' : ''}`}>{value}</div>
  </div>
);

const InventoryTable = ({ items, formatter, onAction, cardClass, darkMode }) => {
  if (items.length === 0) return (
    <div className={`text-center py-16 rounded-2xl border border-dashed ${darkMode ? 'border-gray-700 text-gray-500' : 'border-gray-300 text-gray-400'}`}>
      <Archive size={48} className="mx-auto mb-4 opacity-50" />
      <p className="text-lg font-medium">Your inventory is empty</p>
      <p className="text-sm">Add your first item to get started</p>
    </div>
  );

  return (
    <div className={`rounded-2xl border overflow-hidden ${cardClass}`}>
      <div className="overflow-x-auto">
        <table className="w-full text-left">
          <thead className={`bg-gray-50/50 border-b ${darkMode ? 'bg-gray-800 border-gray-700' : 'border-gray-100'}`}>
            <tr>
              <th className="p-4 font-semibold text-sm opacity-70">Details</th>
              <th className="p-4 font-semibold text-sm opacity-70">Status</th>
              <th className="p-4 font-semibold text-sm opacity-70 text-right">Actions</th>
            </tr>
          </thead>
          <tbody className={`divide-y ${darkMode ? 'divide-gray-700' : 'divide-gray-100'}`}>
            {items.map(item => (
              <tr key={item.id} className={`group transition-colors ${darkMode ? 'hover:bg-gray-800' : 'hover:bg-gray-50'}`}>
                <td className="p-4">
                  <div className="font-bold text-lg">{item.name}</div>
                  <div className="text-sm opacity-60 space-x-2">
                    <span>{item.sku || 'No SKU'}</span>
                    <span>•</span>
                    <span>{item.category || 'Uncategorized'}</span>
                    <span>•</span>
                    <span>{formatter.format(item.price)}</span>
                  </div>
                  {item.description && <div className="text-xs opacity-50 mt-1 italic truncate max-w-xs">{item.description}</div>}
                </td>
                <td className="p-4 align-top pt-5">
                  <StatusBadge quantity={item.quantity} />
                  <div className="text-xs mt-1 opacity-50">{item.quantity} units</div>
                </td>
                <td className="p-4 text-right">
                  <div className="flex justify-end gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                    <ActionButton icon={<ShoppingCart size={18} />} color="text-emerald-600 bg-emerald-50 hover:bg-emerald-100" onClick={() => onAction('sell', item)} />
                    <ActionButton icon={<Edit size={18} />} color="text-blue-600 bg-blue-50 hover:bg-blue-100" onClick={() => onAction('edit', item)} />
                    <ActionButton icon={<Trash2 size={18} />} color="text-red-600 bg-red-50 hover:bg-red-100" onClick={() => onAction('delete', item)} />
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

const StatusBadge = ({ quantity }) => {
  if (quantity <= 0) return <span className="px-2.5 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700 border border-red-200">Out of Stock</span>;
  if (quantity < 10) return <span className="px-2.5 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-700 border border-amber-200">Low Stock</span>;
  return <span className="px-2.5 py-1rounded-full text-xs font-bold bg-red-100 text-red-700 border border-red-200">Out of Stock</span>;
  if (quantity < 10) return <span className="px-2.5 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-700 border border-amber-200">Low Stock</span>;
  return <span className="px-2.5 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-700 border border-emerald-200">In Stock</span>;
};

const ActionButton = ({ icon, color, onClick }) => (
  <button onClick={onClick} className={`p-2 rounded-lg transition-colors ${color}`}>
    {icon}
  </button>
);

// --- MODALS & FORMS ---

const Modal = ({ title, onClose, children, cardClass }) => (
  <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
    <div className={`w-full max-w-md rounded-2xl shadow-2xl transform transition-all scale-100 ${cardClass} max-h-[90vh] overflow-y-auto`}>
      <div className="flex justify-between items-center p-5 border-b border-gray-100/20">
        <h3 className="text-xl font-bold">{title}</h3>
        <button onClick={onClose} className="p-1 hover:bg-gray-100/10 rounded-full transition-colors"><X size={24} /></button>
      </div>
      <div className="p-6">{children}</div>
    </div>
  </div>
);

const ItemModal = ({ title, initialData = {}, onClose, onSubmit, cardClass }) => {
  const { settings, callGeminiAPI, isGenerating, setIsGenerating } = useContext(AppContext);
  const [formData, setFormData] = useState({
    name: initialData.name || '',
    sku: initialData.sku || '',
    category: initialData.category || '',
    price: initialData.price || '',
    quantity: initialData.quantity || '',
    description: initialData.description || ''
  });

  const handleGen = async (field) => {
    if (isGenerating || !formData.name) return;
    setIsGenerating(true);
    
    let prompt = "";
    if (field === 'desc') prompt = `Write a 1-sentence commercial description for a product named "${formData.name}".`;
    if (field === 'cat') prompt = `Suggest one generic retail category for "${formData.name}". Return only the category name.`;
    
    const result = await callGeminiAPI(prompt, "You are a retail assistant.", settings.apiKey);
    
    if (field === 'desc') setFormData(prev => ({ ...prev, description: result }));
    if (field === 'cat') setFormData(prev => ({ ...prev, category: result.trim() }));
    setIsGenerating(false);
  };

  return (
    <Modal title={title} onClose={onClose} cardClass={cardClass}>
      <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); }} className="space-y-4">
        <div className="space-y-1">
          <label className="text-xs font-bold uppercase opacity-70">Item Name</label>
          <input required className="w-full p-3 rounded-xl border bg-transparent outline-none focus:ring-2 focus:ring-blue-500" 
            value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div className="space-y-1">
            <label className="text-xs font-bold uppercase opacity-70">Price</label>
            <input required type="number" step="0.01" className="w-full p-3 rounded-xl border bg-transparent outline-none focus:ring-2 focus:ring-blue-500" 
              value={formData.price} onChange={e => setFormData({...formData, price: parseFloat(e.target.value)})} />
          </div>
          <div className="space-y-1">
            <label className="text-xs font-bold uppercase opacity-70">Quantity</label>
            <input required type="number" className="w-full p-3 rounded-xl border bg-transparent outline-none focus:ring-2 focus:ring-blue-500" 
              value={formData.quantity} onChange={e => setFormData({...formData, quantity: parseInt(e.target.value)})} />
          </div>
        </div>

        <div className="space-y-1">
          <div className="flex justify-between">
            <label className="text-xs font-bold uppercase opacity-70">Category</label>
            <button type="button" onClick={() => handleGen('cat')} className="text-xs text-purple-600 flex items-center hover:underline disabled:opacity-50" disabled={!formData.name || isGenerating}>
               <Sparkles size={12} className="mr-1" /> Auto-Suggest
            </button>
          </div>
          <input className="w-full p-3 rounded-xl border bg-transparent outline-none focus:ring-2 focus:ring-blue-500" 
            value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})} />
        </div>

        <div className="space-y-1">
          <div className="flex justify-between">
            <label className="text-xs font-bold uppercase opacity-70">Description</label>
            <button type="button" onClick={() => handleGen('desc')} className="text-xs text-purple-600 flex items-center hover:underline disabled:opacity-50" disabled={!formData.name || isGenerating}>
               {isGenerating ? <Loader2 size={12} className="animate-spin mr-1"/> : <Sparkles size={12} className="mr-1" />} Generate with AI
            </button>
          </div>
          <textarea rows="2" className="w-full p-3 rounded-xl border bg-transparent outline-none focus:ring-2 focus:ring-blue-500" 
            value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} />
        </div>

        <button type="submit" className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-colors shadow-lg shadow-blue-600/20">
          Save Item
        </button>
      </form>
    </Modal>
  );
};

const SellModal = ({ item, onClose, onConfirm, cardClass, formatter }) => {
  const [qty, setQty] = useState(1);
  return (
    <Modal title={`Sell ${item.name}`} onClose={onClose} cardClass={cardClass}>
      <div className="space-y-6 text-center">
        <div className="text-4xl font-bold text-blue-600">{qty}</div>
        <div className="flex justify-center gap-4">
          <button onClick={() => setQty(Math.max(1, qty - 1))} className="p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-800"><Minus size={16} /></button>
          <button onClick={() => setQty(Math.min(item.quantity, qty + 1))} className="p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-800"><Plus size={16} /></button>
        </div>
        <div className="p-4 bg-gray-50/50 rounded-xl text-sm opacity-80">
          Total: <span className="font-bold text-base">{formatter.format(qty * item.price)}</span>
        </div>
        <button onClick={() => onConfirm(item, qty)} className="w-full py-3 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-600/20">
          Confirm Sale
        </button>
      </div>
    </Modal>
  );
};

const DeleteConfirm = ({ item, onClose, onConfirm, cardClass }) => (
  <Modal title="Delete Item?" onClose={onClose} cardClass={cardClass}>
    <p className="mb-6 opacity-80">Are you sure you want to delete <b>{item.name}</b>? This cannot be undone.</p>
    <div className="flex gap-3">
      <button onClick={onClose} className="flex-1 py-3 border rounded-xl hover:bg-gray-100/10">Cancel</button>
      <button onClick={onConfirm} className="flex-1 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 shadow-lg shadow-red-600/20">Delete</button>
    </div>
  </Modal>
);

const SettingsModal = ({ onClose, cardClass }) => {
  const { settings, setSettings } = useContext(AppContext);
  return (
    <Modal title="Settings" onClose={onClose} cardClass={cardClass}>
      <div className="space-y-4">
        <div className="space-y-1">
          <label className="text-xs font-bold uppercase opacity-70">Store Name</label>
          <input className="w-full p-3 rounded-xl border bg-transparent outline-none" 
            value={settings.storeName} onChange={e => setSettings({...settings, storeName: e.target.value})} />
        </div>
        <div className="space-y-1">
          <label className="text-xs font-bold uppercase opacity-70">Currency</label>
          <select className="w-full p-3 rounded-xl border bg-transparent outline-none" 
            value={settings.currency} onChange={e => setSettings({...settings, currency: e.target.value})}>
            <option value="PHP">PHP (₱)</option>
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (€)</option>
          </select>
        </div>
        <div className="space-y-1">
          <label className="text-xs font-bold uppercase opacity-70">Gemini API Key</label>
          <input type="password" placeholder="Paste your key here" className="w-full p-3 rounded-xl border bg-transparent outline-none" 
            value={settings.apiKey} onChange={e => setSettings({...settings, apiKey: e.target.value})} />
          <p className="text-[10px] opacity-50">Required for AI features. Key is stored locally on your device.</p>
        </div>
      </div>
    </Modal>
  );
};

const InsightsModal = ({ data, onClose, cardClass }) => {
  const { callGeminiAPI, settings } = useContext(AppContext);
  const [insight, setInsight] = useState("");
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const gen = async () => {
      const prompt = `Analyze this store data and give 3 specific bullet points on what to restock or sell. Data: ${data.metrics.totalItems} items, ${data.metrics.lowStock} low stock. Sales total: ${data.metrics.salesTotal}.`;
      const res = await callGeminiAPI(prompt, "You are a business analyst.", settings.apiKey);
      setInsight(res);
      setLoading(false);
    };
    gen();
  }, []);

  return (
    <Modal title="AI Business Analyst" onClose={onClose} cardClass={cardClass}>
      {loading ? (
        <div className="py-8 text-center"><Loader2 className="animate-spin mx-auto mb-2"/> Analyzing data...</div>
      ) : (
        <div className="whitespace-pre-wrap opacity-80 leading-relaxed">{insight}</div>
      )}
    </Modal>
  );
};

const HistoryList = ({ history, cardClass }) => (
  <div className="space-y-4">
    {history.length === 0 && <div className="text-center opacity-50 py-10">No history yet.</div>}
    {history.map(h => (
      <div key={h.id} className={`p-4 rounded-xl border flex justify-between items-center ${cardClass}`}>
        <div>
          <div className="font-bold">{h.action}</div>
          <div className="text-sm opacity-60">{h.details}</div>
        </div>
        <div className="text-xs opacity-40">{new Date(h.timestamp).toLocaleDateString()}</div>
      </div>
    ))}
  </div>
);

export default App;
